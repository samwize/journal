#!/usr/bin/env ruby

require 'rubygems'
require "bundler/setup"
require 'commander/import'
require 'json'

program :name, "Journal"
program :version, '1.1.0'
program :description, 'A cli for creating journal entry with correct file name'

command :new do |c|
  c.syntax = 'journal new "My entry"'
  c.description = 'Create yyyy-MM-dd-my-entry.md'
  c.option '--format STRING', String, 'Option file format md (default) or markdown'
  c.option '-d STRING', String, 'Option directory to create journal in'
  c.action do |args, options|
    options.default :format => 'md', :d => '.'
  	title = args[0]
    createJournal(title, options.format, options.d)
  end
end

command :newpage do |c|
  c.syntax = 'journal newpage "My page"'
  c.description = 'Create my-page.md in current folder'
  c.option '--format STRING', String, 'Option file format md (default) or markdown'
  c.option '-d STRING', String, 'Option directory to create journal in'
  c.action do |args, options|
    options.default :format => 'md', :d => '.'
  	title = args[0]
    createPage(title, options.format, options.d)
  end
end

command :dehtml do |c|
  c.syntax = 'journal dehtml xxx.html'
  c.description = 'Convert xxx.markdown'
  c.action do |args, options|
    htmlfile = args[0]
    convertHtmlToMarkdown(htmlfile)
  end
end

def createJournal(title, format, directory)
  slug = title.downcase.strip.gsub(' ', '-').gsub(/[^\w-]/, '')
  today = DateTime.now.strftime('%Y-%m-%d')
  filename = today + "-" + slug + "." + format
  fullpath = File.join(directory, filename)
  createFile(fullpath, "# #{title}")
end

def createPage(title, format, directory)
  slug = title.downcase.strip.gsub(' ', '-').gsub(/[^\w-]/, '')
  filename = slug + "." + format
  fullpath = File.join(directory, filename)
  createFile(fullpath, "# #{title}")
end

def createFile(path, content)
  File.open(path, 'w') {|f| f.write(content) }
  puts "#{path}"
end

def convertHtmlToMarkdown(htmlfile)
  contents = File.open(htmlfile, "rb") { |f| f.read }
  md = contents.gsub(/<br \/>/, "\n")
    .gsub(/&nbsp;/, " ")
    .gsub(/<i>(.*?)<\/i>/, "_\\1_")
    .gsub(/<blockquote.*?>(.*?)<\/blockquote>/, "\n> \\1\n\n")
    .gsub(/<a href=\"(http.*?)\".*?>(.*?)<\/a>/, "[\\2](\\1)")
    .gsub(/<img.*?src=\"(http.*?\").*?\/>/, "![](\\1)")
    .gsub(/<\/?div.*?>/, "")
    .gsub(/<h3>(.*?)<\/h3>/, "## $1\n\n")
    .gsub(/^blogger_id:.*?\n/, "")
    .gsub(/^blogger_orig_url:.*?\n/, "")
    .gsub(/^modified_time:.*?\n/, "")
  # puts "#{md}"

  mdFile = htmlfile.gsub(".html", ".markdown")

  File.open(mdFile, "w") do |f|
    f.write(md)
  end

  File.delete(htmlfile)
end
