#!/usr/bin/env ruby

require 'rubygems'
require "bundler/setup"
require 'commander/import'
require 'json'

program :name, "Journal"
program :version, '1.1.0'
program :description, 'A cli for creating journal entry with correct file name'

command :new do |c|
  c.syntax = 'journal new "My entry"'
  c.description = 'Create yyyy-MM-dd-my-entry.md'
  c.option '--format STRING', String, 'Option file format md (default) or markdown'
  c.option '-d STRING', String, 'Option directory to create journal in'
  c.action do |args, options|
    options.default :format => 'md', :d => '.'
  	title = args[0]
    createJournal(title, options.format, options.d)
  end
end

command :newpage do |c|
  c.syntax = 'journal newpage "My page"'
  c.description = 'Create my-page.md in current folder'
  c.option '--format STRING', String, 'Option file format md (default) or markdown'
  c.option '-d STRING', String, 'Option directory to create journal in'
  c.action do |args, options|
    options.default :format => 'md', :d => '.'
  	title = args[0]
    createPage(title, options.format, options.d)
  end
end

command :dehtml do |c|
  c.syntax = 'journal dehtml xxx.html'
  c.description = 'Convert xxx.markdown'
  c.action do |args, options|
    htmlfile = args[0]
    convertHtmlToMarkdown(htmlfile)
  end
end

def createJournal(title, format, directory)
  slug = title.downcase.strip.gsub(' ', '-').gsub(/[^\w-]/, '')
  today = DateTime.now.strftime('%Y-%m-%d')
  filename = today + "-" + slug + "." + format
  fullpath = File.join(directory, filename)
  createFile(fullpath, "# #{title}")
end

def createPage(title, format, directory)
  slug = title.downcase.strip.gsub(' ', '-').gsub(/[^\w-]/, '')
  filename = slug + "." + format
  fullpath = File.join(directory, filename)
  createFile(fullpath, "# #{title}")
end

def createFile(path, content)
  File.open(path, 'w') {|f| f.write(content) }
  puts "#{path}"
end

def convertHtmlToMarkdown(htmlfile)
  mdFile = htmlfile.gsub(".html", ".markdown")
  File.rename(htmlfile, mdFile)

  contents = File.open(mdFile, "rb") { |f| f.read }
  md = contents.gsub(/<br \/>/, "\n")
    .gsub(/&nbsp;/, " ")
    .gsub(/&amp;/, "&")
    .gsub(/&lt;/, "<")
    .gsub(/&gt;/, ">")
    .gsub(/<i>(.*?)<\/i>/, "_\\1_")
    .gsub(/<em.*?>(.*?)<\/em>/, "_\\1_")
    .gsub(/<font .*?italic.*?>(.*?)<\/font>/, "_\\1_")
    .gsub(/<b>(.*?)<\/b>/, "**\\1**")
    .gsub(/<strong.*?>(.*?)<\/strong>/, "**\\1**")
    .gsub(/<font .*?bold.*?>(.*?)<\/font>/, "**\\1**")
    .gsub(/<strike.*?>(.*?)<\/strike>/, "~~\\1~~")
    .gsub(/<a .*?href=\"(http.*?)\".*?>(.*?)<\/a>/, "[\\2](\\1)")
    .gsub(/<img.*?src=\"(http.*?)\".*?\/>/, "![](\\1)")
    .gsub(/<blockquote.*?>(.*?)<\/blockquote>/, "\n> \\1\n\n")
    .gsub(/<span.*?>([\s\S]*?)<\/span>/, "\\1")
    .gsub(/<time.*?>(.*?)<\/time>/, "\\1")
    .gsub(/<\/?div.*?>/, "\n")
    .gsub(/<p.*?>([\s\S]*?)<\/p>/, "\n\n\\1\n")
    .gsub(/<\/?section.*?>/, "\n")
    .gsub(/<\/?figure.*?>/, "\n")
    .gsub(/<\/?canvas.*?>/, "\n")
    .gsub(/<\/?table.*?>/, "")
    .gsub(/<\/?tbody.*?>/, "")
    .gsub(/<tr.*?>/, "\n")
    .gsub(/<\/tr.*?>/, "")
    .gsub(/<\/?td.*?>/, "")
    .gsub(/<pre.*?>([\s\S]*?)<\/pre>/, "\n```\n\\1\n```\n")
    .gsub(/<h2.*?>(.*?)<\/h2>/, "\n# \\1\n\n")
    .gsub(/<h3.*?>(.*?)<\/h3>/, "\n## \\1\n\n")
    .gsub(/<\/?ul.*?>/, "\n")
    .gsub(/<\/ol.*?>/, "\n") # Only </ol>, so that we can manually fix for <ol> numbering
    .gsub(/<li.*?>([\s\S]*?)<\/li>/, "\n- \\1")
    .gsub(/<hr.*?\/>/, "---\n")
    .gsub(/<hr.*?\/>/, "---\n")
    .gsub(/^blogger_id:.*?\n/, "")
    .gsub(/^blogger_orig_url:.*?\n/, "")
    .gsub(/^modified_time:.*?\n/, "")
    .gsub(/^thumbnail:.*?\n/, "")
    .gsub(/^(?:[\t ]*(?:\r?\n|\r))+/, "\n")
    .gsub(/[\n]{3,}/, "\n\n")
  # puts "#{md}"

  File.open(mdFile, "w") do |f|
    f.write(md)
  end
end
